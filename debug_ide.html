<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Simple Programming Language - Debug Version</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1e1e1e;
            color: white;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .editor-panel, .output-panel {
            width: 45%;
            float: left;
            margin: 10px;
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 5px;
        }
        .panel-header {
            background: #333;
            padding: 10px;
            font-weight: bold;
        }
        #code-editor {
            width: 100%;
            height: 300px;
            background: #1e1e1e;
            color: #f8f8f2;
            border: none;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
        }
        #output {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn:disabled {
            background: #666;
        }
        .error { color: #ff4444; }
        .output { color: #00ff00; }
        .print { color: #ffffff; }
    </style>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
</head>
<body>
    <div class="container">
        <h1>Simple Programming Language - Debug Version</h1>
        <div id="status">Loading...</div>
        
        <button id="run-btn" class="btn" disabled onclick="runCode()">Run Code</button>
        <button class="btn" onclick="clearOutput()">Clear</button>
        <button class="btn" onclick="loadExample()">Example</button>
        
        <div style="clear: both;">
            <div class="editor-panel">
                <div class="panel-header">Code Editor</div>
                <textarea id="code-editor">x = 5
print("Hello World")
print("x =", x)</textarea>
            </div>

            <div class="output-panel">
                <div class="panel-header">Output</div>
                <div id="output">Ready...</div>
            </div>
        </div>
    </div>

    <script>
        let pyodide;

        // Super simple SPL implementation
        const simpleLanguage = `
class SimpleSPL:
    def __init__(self):
        self.variables = {}
        self.output = []
    
    def run(self, code):
        self.output = []
        lines = code.strip().split('\\n')
        
        for line in lines:
            line = line.strip()
            if not line or line.startswith('#'):
                continue
            
            try:
                self.execute_line(line)
            except Exception as e:
                self.output.append(f"Error: {str(e)}")
                break
        
        return self.output
    
    def execute_line(self, line):
        # Handle print statements
        if line.startswith('print(') and line.endswith(')'):
            content = line[6:-1]  # Remove 'print(' and ')'
            self.handle_print(content)
        
        # Handle assignments
        elif '=' in line and not any(op in line for op in ['>', '<', '==']):
            parts = line.split('=', 1)
            var_name = parts[0].strip()
            expression = parts[1].strip()
            value = self.evaluate(expression)
            self.variables[var_name] = value
        
        # Handle expressions
        else:
            result = self.evaluate(line)
            if result is not None:
                self.output.append(str(result))
    
    def handle_print(self, content):
        # Handle multiple arguments separated by commas
        if ',' in content:
            parts = []
            for part in content.split(','):
                part = part.strip()
                value = self.evaluate(part)
                parts.append(str(value))
            self.output.append(' '.join(parts))
        else:
            value = self.evaluate(content)
            self.output.append(str(value))
    
    def evaluate(self, expr):
        expr = expr.strip()
        
        # Handle string literals
        if (expr.startswith('"') and expr.endswith('"')) or (expr.startswith("'") and expr.endswith("'")):
            return expr[1:-1]
        
        # Handle numbers
        try:
            if '.' in expr:
                return float(expr)
            return int(expr)
        except ValueError:
            pass
        
        # Handle variables
        if expr in self.variables:
            return self.variables[expr]
        
        # Handle simple arithmetic
        if '+' in expr:
            parts = expr.split('+')
            if len(parts) == 2:
                left = self.evaluate(parts[0].strip())
                right = self.evaluate(parts[1].strip())
                if isinstance(left, str) or isinstance(right, str):
                    return str(left) + str(right)
                return left + right
        
        if '-' in expr and not expr.startswith('-'):
            parts = expr.split('-')
            if len(parts) == 2:
                left = self.evaluate(parts[0].strip())
                right = self.evaluate(parts[1].strip())
                return left - right
        
        if '*' in expr:
            parts = expr.split('*')
            if len(parts) == 2:
                left = self.evaluate(parts[0].strip())
                right = self.evaluate(parts[1].strip())
                return left * right
        
        if '/' in expr:
            parts = expr.split('/')
            if len(parts) == 2:
                left = self.evaluate(parts[0].strip())
                right = self.evaluate(parts[1].strip())
                if right == 0:
                    raise Exception("Division by zero")
                return left / right
        
        # Try to evaluate as Python expression (fallback)
        try:
            # Create a safe environment with only our variables
            safe_dict = dict(self.variables)
            return eval(expr, {"__builtins__": {}}, safe_dict)
        except:
            raise Exception(f"Cannot evaluate: {expr}")

# Create global interpreter
spl = SimpleSPL()

def run_code(code):
    return spl.run(code)

print("Simple SPL ready!")
`;

        async function init() {
            try {
                document.getElementById('status').textContent = 'Loading Pyodide...';
                pyodide = await loadPyodide();
                
                document.getElementById('status').textContent = 'Loading SPL...';
                pyodide.runPython(simpleLanguage);
                
                document.getElementById('status').textContent = 'Ready!';
                document.getElementById('run-btn').disabled = false;
                
            } catch (error) {
                document.getElementById('status').textContent = 'Error: ' + error.message;
            }
        }

        function runCode() {
            console.log('runCode called');
            const code = document.getElementById('code-editor').value;
            const output = document.getElementById('output');
            
            if (!code.trim()) {
                output.innerHTML = '<span class="error">No code to run!</span>';
                return;
            }
            
            try {
                output.innerHTML = '<span class="output">Running...</span>';
                console.log('About to execute code:', code);
                
                setTimeout(() => {
                    try {
                        pyodide.globals.set('user_code', code);
                        const result = pyodide.runPython('run_code(user_code)');
                        console.log('Python result:', result);
                        
                        let outputText = '';
                        if (result && result.length > 0) {
                            result.forEach(line => {
                                if (line.startsWith('Error:')) {
                                    outputText += `<span class="error">${line}</span>\n`;
                                } else {
                                    outputText += `<span class="print">${line}</span>\n`;
                                }
                            });
                        } else {
                            outputText = '<span class="output">Code executed (no output)</span>';
                        }
                        
                        output.innerHTML = outputText;
                        
                    } catch (error) {
                        console.error('Python execution error:', error);
                        output.innerHTML = `<span class="error">Error: ${error.message}</span>`;
                    }
                }, 100);
                
            } catch (error) {
                console.error('JavaScript error:', error);
                output.innerHTML = `<span class="error">JavaScript Error: ${error.message}</span>`;
            }
        }

        function clearOutput() {
            console.log('clearOutput called');
            document.getElementById('output').innerHTML = 'Output cleared...';
        }

        function loadExample() {
            console.log('loadExample called');
            document.getElementById('code-editor').value = `x = 10
y = 20
print("Hello from SPL!")
print("x =", x)
print("y =", y)
print("x + y =", x + y)`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('run-btn').addEventListener('click', runCode);
            
            // Also add keyboard shortcut
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    runCode();
                }
            });
            
            init();
        });
    </script>
</body>
</html>
